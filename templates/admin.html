<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administrador</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Mensajes flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages-main">
        {% for category, message in messages %}
          <div class="flash-message-main flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Header de administrador -->
  <header class="admin-header">
    <div class="admin-title">
      <h1>üõ†Ô∏è Panel de Administrador</h1>
    </div>
    <div class="admin-info">
      <span>{{ session.get('nombre', 'Admin') }} {{ session.get('apellido', '') }}</span>
      <a href="/logout" class="logout-btn">Cerrar Sesi√≥n</a>
    </div>
  </header>

  <!-- Panel principal -->
  <main class="admin-main">
    <div class="stats-section">
      <div class="stat-card">
        <h3>Total de Usuarios</h3>
        <div class="stat-number">{{ users|length }}</div>
      </div>
      <div class="stat-card">
        <h3>Saldo Total del Sistema</h3>
        <div class="stat-number">${{ "%.2f"|format(users|sum(attribute='saldo')) }}</div>
      </div>
    </div>

    <!-- Lista de usuarios -->
    <section class="users-section">
      <h2>Gesti√≥n de Usuarios</h2>
      
      {% if users %}
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Correo</th>
                <th>Tel√©fono</th>
                <th>Saldo</th>
                <th>Fecha Registro</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.nombre }}</td>
                <td>{{ user.apellido }}</td>
                <td>{{ user.correo }}</td>
                <td>{{ user.telefono }}</td>
                <td class="balance">${{ "%.2f"|format(user.saldo) }}</td>
                <td>{{ user.fecha_registro[:10] }}</td>
                <td class="actions">
                  <!-- Agregar cr√©dito -->
                  <form method="POST" action="/admin/add_credit" class="inline-form">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="number" name="amount" placeholder="Monto" step="0.01" min="0.01" required class="small-input">
                    <button type="submit" class="btn btn-success">+ Cr√©dito</button>
                  </form>
                  
                  <!-- Modificar saldo -->
                  <form method="POST" action="/admin/update_balance" class="inline-form">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="number" name="new_balance" placeholder="Nuevo saldo" step="0.01" min="0" required class="small-input">
                    <button type="submit" class="btn btn-warning">Modificar</button>
                  </form>
                  
                  <!-- Eliminar usuario -->
                  <form method="POST" action="/admin/delete_user" class="inline-form" onsubmit="return confirm('¬øEst√°s seguro de eliminar este usuario? Esta acci√≥n no se puede deshacer.')">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-users">
          <p>No hay usuarios registrados en el sistema.</p>
        </div>
      {% endif %}
    </section>

    <!-- Gesti√≥n de Pines Free Fire -->
    <section class="pins-section">
      <h2>üìå Gesti√≥n de Pines Free Fire</h2>
      
      <div class="pin-management">
        <div class="pin-forms-container">
          <!-- Agregar Pin Individual -->
          <div class="pin-form-section">
            <h3>Agregar Pin Individual</h3>
            <form method="POST" action="/admin/add_pin" class="admin-form">
              <div class="form-group">
                <label for="monto_id">Tipo de Paquete:</label>
                <select id="monto_id" name="monto_id" required>
                  <option value="">Seleccione paquete</option>
                  {% for price in prices %}
                    <option value="{{ price.id }}">{{ price.nombre }} / ${{ "%.2f"|format(price.precio) }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label for="pin_codigo">C√≥digo del Pin:</label>
                <input type="text" id="pin_codigo" name="pin_codigo" placeholder="Ingrese el c√≥digo del pin" required>
              </div>
              <button type="submit" class="btn btn-primary">Agregar Pin</button>
            </form>
          </div>

          <!-- Agregar Pines en Lote -->
          <div class="pin-form-section">
            <h3>üì¶ Agregar Pines en Lote</h3>
            <p class="batch-info">Agregue hasta 10 pines a la vez. Separe cada pin con una l√≠nea nueva o coma.</p>
            <form method="POST" action="/admin/add_pins_batch" class="admin-form">
              <div class="form-group">
                <label for="batch_monto_id">Tipo de Paquete:</label>
                <select id="batch_monto_id" name="batch_monto_id" required>
                  <option value="">Seleccione paquete</option>
                  {% for price in prices %}
                    <option value="{{ price.id }}">{{ price.nombre }} / ${{ "%.2f"|format(price.precio) }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label for="pins_batch">C√≥digos de Pines (m√°ximo 10):</label>
                <textarea id="pins_batch" name="pins_batch" rows="6" placeholder="Ingrese los c√≥digos de pines, uno por l√≠nea:&#10;PIN123456&#10;PIN789012&#10;PIN345678&#10;..." required></textarea>
                <small class="form-help">Separe cada pin con una l√≠nea nueva o coma. M√°ximo 10 pines por lote.</small>
              </div>
              <button type="submit" class="btn btn-success">üì¶ Agregar Lote de Pines</button>
            </form>
          </div>
        </div>
      </div>

      <div class="pin-stock">
        <h3>Stock de Pines</h3>
        <div class="stock-grid">
          {% for price in prices %}
          <div class="stock-item">
            <span>{{ price.nombre }} / ${{ "%.2f"|format(price.precio) }}</span>
            <span class="stock-count">{{ pin_stock.get(price.id, 0) }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- Gesti√≥n de Precios -->
    <section class="prices-section">
      <h2>üí∞ Gesti√≥n de Precios</h2>
      
      <div class="prices-management">
        <p class="prices-info">Modifique los precios de los paquetes. Los cambios se aplicar√°n inmediatamente en toda la aplicaci√≥n.</p>
        
        <div class="prices-grid">
          {% for price in prices %}
          <div class="price-card">
            <div class="price-header">
              <h4>{{ price.nombre }}</h4>
              <span class="current-price">${{ "%.2f"|format(price.precio) }}</span>
            </div>
            <div class="price-description">{{ price.descripcion }}</div>
            
            <form method="POST" action="/admin/update_price" class="price-form">
              <input type="hidden" name="package_id" value="{{ price.id }}">
              <div class="price-input-group">
                <label for="price_{{ price.id }}">Nuevo precio:</label>
                <div class="input-with-button">
                  <input type="number" 
                         id="price_{{ price.id }}" 
                         name="new_price" 
                         step="0.01" 
                         min="0" 
                         value="{{ price.precio }}" 
                         placeholder="0.00" 
                         required>
                  <button type="submit" class="btn btn-update">Actualizar</button>
                </div>
              </div>
            </form>
            
            <div class="price-meta">
              <small>√öltima actualizaci√≥n: {{ price.fecha_actualizacion[:16] if price.fecha_actualizacion else 'N/A' }}</small>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>
  </main>

  <script>
    // Auto-ocultar mensajes flash despu√©s de 2 segundos
    setTimeout(function() {
      const flashMessages = document.querySelector('.flash-messages-main');
      if (flashMessages) {
        flashMessages.style.opacity = '0';
        setTimeout(() => flashMessages.remove(), 300);
      }
    }, 2000);
  </script>
</body>
</html>

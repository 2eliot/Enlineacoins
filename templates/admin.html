<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administrador</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Mensajes flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages-main">
        {% for category, message in messages %}
          <div class="flash-message-main flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Header de administrador -->
  <header class="admin-header">
    <div class="admin-title">
      <h1>üõ†Ô∏è Panel de Administrador</h1>
    </div>
    <div class="admin-info">
      <span>{{ session.get('nombre', 'Admin') }} {{ session.get('apellido', '') }}</span>
      <a href="/" class="btn" style="background: #007bff; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin-right: 10px;">üè† Volver al Inicio</a>
      <a href="/logout" class="logout-btn">Cerrar Sesi√≥n</a>
    </div>
  </header>

  <!-- Panel principal -->
  <main class="admin-main">
    <!-- Estad√≠sticas generales -->
    <div class="stats-section">
      <div class="stat-card">
        <h3>Total de Usuarios</h3>
        <div class="stat-number">{{ users|length }}</div>
      </div>
      <div class="stat-card">
        <h3>Saldo Total del Sistema</h3>
        <div class="stat-number">${{ "%.2f"|format(users|sum(attribute='saldo')) }}</div>
      </div>
    </div>

    <!-- Sistema de pesta√±as -->
    <div class="tabs-container">
      <div class="tabs-header">
        <button class="tab-button active" onclick="showTab('usuarios')">üë• Usuarios</button>
        <button class="tab-button" onclick="showTab('pines')">üìå Gestor de Pines</button>
        <button class="tab-button" onclick="showTab('precios')">üí∞ Precios</button>
        <button class="tab-button" onclick="showTab('noticias')">üì∞ Noticias</button>
      </div>

      <!-- Pesta√±a de Usuarios -->
      <div id="tab-usuarios" class="tab-content active">
        <section class="users-section">
      <h2>Gesti√≥n de Usuarios</h2>
      
      {% if users %}
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Correo</th>
                <th>Tel√©fono</th>
                <th>Saldo</th>
                <th>Fecha Registro</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.nombre }}</td>
                <td>{{ user.apellido }}</td>
                <td>{{ user.correo }}</td>
                <td>{{ user.telefono }}</td>
                <td class="balance">${{ "%.2f"|format(user.saldo) }}</td>
                <td>{{ user.fecha_registro[:10] }}</td>
                <td class="actions">
                  <!-- Agregar cr√©dito -->
                  <form method="POST" action="/admin/add_credit" class="inline-form">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="number" name="amount" placeholder="Monto" step="0.01" min="0.01" required class="small-input">
                    <button type="submit" class="btn btn-success">+ Cr√©dito</button>
                  </form>
                  
                  <!-- Modificar saldo -->
                  <form method="POST" action="/admin/update_balance" class="inline-form">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="number" name="new_balance" placeholder="Nuevo saldo" step="0.01" min="0" required class="small-input">
                    <button type="submit" class="btn btn-warning">Modificar</button>
                  </form>
                  
                  <!-- Eliminar usuario -->
                  <form method="POST" action="/admin/delete_user" class="inline-form" onsubmit="return confirm('¬øEst√°s seguro de eliminar este usuario? Esta acci√≥n no se puede deshacer.')">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-users">
          <p>No hay usuarios registrados en el sistema.</p>
        </div>
      {% endif %}
        </section>
      </div>

      <!-- Pesta√±a de Gestor de Pines -->
      <div id="tab-pines" class="tab-content">
        <section class="pins-section">
      <h2>üìå Gesti√≥n de Pines Free Fire</h2>
      
      <div class="pin-management">
        <div class="pin-forms-container">
          <!-- Agregar Pin Individual -->
          <div class="pin-form-section">
            <h3>Agregar Pin Individual</h3>
            <form method="POST" action="/admin/add_pin" class="admin-form">
              <div class="form-group">
                <label for="game_type_single">üéÆ Juego:</label>
                <select id="game_type_single" name="game_type" onchange="updateSinglePinPackages()" required>
                  <option value="">Seleccione juego</option>
                  <option value="freefire_latam">Free Fire Latam</option>
                  <option value="freefire_global">Free Fire</option>
                </select>
              </div>
              <div class="form-group">
                <label for="monto_id">Tipo de Paquete:</label>
                <select id="monto_id" name="monto_id" required disabled>
                  <option value="">Seleccione paquete</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pin_codigo">C√≥digo del Pin:</label>
                <input type="text" id="pin_codigo" name="pin_codigo" placeholder="Ingrese el c√≥digo del pin" required>
              </div>
              <button type="submit" class="btn btn-primary">Agregar Pin</button>
            </form>
          </div>

          <!-- Agregar Pines en Lote -->
          <div class="pin-form-section">
            <h3>üì¶ Agregar Pines en Lote</h3>
            <p class="batch-info">Agregue hasta 10 pines a la vez. Separe cada pin con una l√≠nea nueva o coma.</p>
            <form method="POST" action="/admin/add_pins_batch" class="admin-form">
              <div class="form-group">
                <label for="game_type_batch">üéÆ Juego:</label>
                <select id="game_type_batch" name="game_type" onchange="updateBatchPinPackages()" required>
                  <option value="">Seleccione juego</option>
                  <option value="freefire_latam">Free Fire Latam</option>
                  <option value="freefire_global">Free Fire</option>
                </select>
              </div>
              <div class="form-group">
                <label for="batch_monto_id">Tipo de Paquete:</label>
                <select id="batch_monto_id" name="batch_monto_id" required disabled>
                  <option value="">Seleccione paquete</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pins_batch">C√≥digos de Pines (m√°ximo 10):</label>
                <textarea id="pins_batch" name="pins_batch" rows="6" placeholder="Ingrese los c√≥digos de pines, uno por l√≠nea:&#10;PIN123456&#10;PIN789012&#10;PIN345678&#10;..." required></textarea>
                <small class="form-help">Separe cada pin con una l√≠nea nueva o coma. M√°ximo 10 pines por lote.</small>
              </div>
              <button type="submit" class="btn btn-success">üì¶ Agregar Lote de Pines</button>
            </form>
          </div>
        </div>
      </div>

        <!-- Stock de Pines por Juego -->
        <div class="pin-stock">
          <h3>üì¶ Stock de Pines por Juego</h3>
          
          <!-- Free Fire LATAM -->
          <div class="game-stock-section">
            <h4>üî• Free Fire LATAM</h4>
            <div class="stock-grid">
              {% for price in prices %}
              <div class="stock-item">
                <div class="stock-info">
                  <span class="package-name">{{ price.nombre }}</span>
                  <span class="package-price">${{ "%.2f"|format(price.precio) }}</span>
                  <span class="stock-count">{{ pin_stock.get(price.id, 0) }} pines</span>
                </div>
                
                <!-- Toggle de configuraci√≥n de fuente -->
                <div class="source-config">
                  <label class="source-label">Fuente:</label>
                  <div class="source-toggle-group">
                    <form method="POST" action="/admin/toggle_pin_source" class="source-toggle-form">
                      <input type="hidden" name="monto_id" value="{{ price.id }}">
                      <input type="hidden" name="fuente" value="local">
                      <button type="submit" class="btn btn-source-toggle btn-local {% if pin_sources_config.get(price.id) == 'local' %}active{% endif %}" 
                              title="Los usuarios obtendr√°n pines del stock local">
                        üì¶ Local {% if pin_sources_config.get(price.id) == 'local' %}‚úì{% endif %}
                      </button>
                    </form>
                    
                    <form method="POST" action="/admin/toggle_pin_source" class="source-toggle-form">
                      <input type="hidden" name="monto_id" value="{{ price.id }}">
                      <input type="hidden" name="fuente" value="api_externa">
                      <button type="submit" class="btn btn-source-toggle btn-api {% if pin_sources_config.get(price.id) == 'api_externa' %}active{% endif %}" 
                              title="Los usuarios obtendr√°n pines directamente de la API externa">
                        üåê API {% if pin_sources_config.get(price.id) == 'api_externa' %}‚úì{% endif %}
                      </button>
                    </form>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          
          <!-- Free Fire Global -->
          <div class="game-stock-section">
            <h4>üéÆ Free Fire</h4>
            <div class="stock-grid">
              {% for price in freefire_global_prices %}
              <div class="stock-item">
                <div class="stock-info">
                  <span class="package-name">{{ price.nombre }}</span>
                  <span class="package-price">${{ "%.2f"|format(price.precio) }}</span>
                  <span class="stock-count">{{ pin_stock_freefire_global.get(price.id, 0) }} pines</span>
                </div>
                
                <div class="source-config">
                  <label class="source-label">Fuente:</label>
                  <div class="source-info">
                    <span class="source-badge">üì¶ Solo Local</span>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          
          <!-- Estado de API Externa -->
          <div class="api-status-section">
            <h4>üåê Estado de API Externa (Solo Free Fire LATAM)</h4>
            <div class="api-status-info">
              <p>La API externa permite obtener pines autom√°ticamente cuando el stock local est√° bajo.</p>
              <form method="POST" action="/admin/test_external_api" class="test-api-form">
                <button type="submit" class="btn btn-test-api">üß™ Probar Conexi√≥n API</button>
              </form>
            </div>
          </div>
          
          <!-- Herramientas de mantenimiento -->
          <div class="pin-maintenance">
            <h3>üîß Herramientas de Mantenimiento</h3>
            <div class="maintenance-actions">
              <form method="POST" action="/admin/remove_duplicates" class="maintenance-form" onsubmit="return confirm('¬øEst√°s seguro de eliminar todos los pines duplicados? Esta acci√≥n no se puede deshacer.')">
                <div class="maintenance-info">
                  <p>üóëÔ∏è <strong>Eliminar Pines Duplicados</strong></p>
                  <small>Esta funci√≥n eliminar√° autom√°ticamente todos los pines duplicados de la base de datos, manteniendo solo el m√°s reciente de cada c√≥digo √∫nico por paquete.</small>
                </div>
                <button type="submit" class="btn btn-maintenance">üóëÔ∏è Eliminar Duplicados</button>
              </form>
            </div>
          </div>
        </div>
        </section>
      </div>

      <!-- Pesta√±a de Precios -->
      <div id="tab-precios" class="tab-content">
        <section class="prices-section">
          <h2>üí∞ Gesti√≥n de Precios</h2>
          
          <div class="prices-management">
            <div class="price-selector-container">
              <h3>Modificar Precios</h3>
              <p class="prices-info">Seleccione el juego y paquete para modificar su precio. Los cambios se aplicar√°n inmediatamente.</p>
              
              <form method="POST" action="/admin/update_price" class="price-selector-form">
                <div class="form-row">
              <div class="form-group">
                <label for="game_select">üéÆ Juego:</label>
                <select id="game_select" onchange="updatePackages()">
                  <option value="freefire">Free Fire Latam</option>
                  <option value="freefire_global">Free Fire</option>
                  <option value="bloodstriker">Blood Striker</option>
                  <option value="other_games" disabled>Otros Juegos (Pr√≥ximamente)</option>
                </select>
              </div>
                  
                  <div class="form-group">
                    <label for="package_select">üì¶ Paquete:</label>
                    <select id="package_select" name="package_id" onchange="updatePriceInfo()" required>
                      <option value="">Seleccione un paquete</option>
                      {% for price in prices %}
                        <option value="{{ price.id }}" 
                                data-current-price="{{ price.precio }}" 
                                data-name="{{ price.nombre }}" 
                                data-description="{{ price.descripcion }}">
                          {{ price.nombre }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="new_price_input">üí∞ Nuevo Precio:</label>
                    <input type="number" 
                           id="new_price_input" 
                           name="new_price" 
                           step="0.01" 
                           min="0" 
                           placeholder="0.00" 
                           required>
                  </div>
                  
                  <div class="form-group">
                    <button type="submit" class="btn btn-update-price">Actualizar Precio</button>
                  </div>
                </div>
              </form>
              
              <div id="price-info" class="price-info-display" style="display: none;">
                <div class="current-price-info">
                  <h4 id="selected-package-name">-</h4>
                  <p id="selected-package-description">-</p>
                  <div class="price-comparison">
                    <span class="current-price-label">Precio actual:</span>
                    <span id="current-price-value" class="current-price-badge">$0.00</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="prices-overview">
              <h3>Vista General de Precios</h3>
              <div class="prices-grid">
                {% for price in prices %}
                <div class="price-overview-card">
                  <div class="price-overview-header">
                    <h4>{{ price.nombre }}</h4>
                    <span class="price-badge">${{ "%.2f"|format(price.precio) }}</span>
                  </div>
                  <p class="price-overview-description">{{ price.descripcion }}</p>
                  <div class="price-overview-meta">
                    <small>Actualizado: {{ price.fecha_actualizacion[:16] if price.fecha_actualizacion else 'N/A' }}</small>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Pesta√±a de Noticias -->
      <div id="tab-noticias" class="tab-content">
        <section class="news-section">
          <h2>üì∞ Gesti√≥n de Noticias</h2>
          
          <div class="news-management">
            <!-- Crear nueva noticia -->
            <div class="create-news-container">
              <h3>‚úçÔ∏è Crear Nueva Noticia</h3>
              <form method="POST" action="/admin/create_news" class="news-form">
                <div class="form-group">
                  <label for="news_title">üìù T√≠tulo de la Noticia:</label>
                  <input type="text" id="news_title" name="titulo" placeholder="Ingrese el t√≠tulo de la noticia" required maxlength="200">
                </div>
                
                <div class="form-group">
                  <label for="news_content">üìÑ Contenido:</label>
                  <textarea id="news_content" name="contenido" rows="6" placeholder="Escriba el contenido de la noticia aqu√≠..." required maxlength="2000"></textarea>
                  <small class="form-help">M√°ximo 2000 caracteres. Puede usar saltos de l√≠nea para organizar el texto.</small>
                </div>
                
                <div class="form-group">
                  <label class="checkbox-label">
                    <input type="checkbox" name="importante" value="1">
                    <span class="checkbox-custom"></span>
                    üì¢ Marcar como noticia importante
                  </label>
                  <small class="form-help">Las noticias importantes aparecen con un badge especial y generan notificaci√≥n.</small>
                </div>
                
                <button type="submit" class="btn btn-create-news">üì∞ Publicar Noticia</button>
              </form>
            </div>
            
            <!-- Lista de noticias existentes -->
            <div class="existing-news-container">
              <h3>üìã Noticias Publicadas</h3>
              {% if noticias %}
                <div class="admin-news-list">
                  {% for noticia in noticias %}
                  <div class="admin-news-card">
                    <div class="admin-news-header">
                      <h4 class="admin-news-title">{{ noticia.titulo }}</h4>
                      <div class="admin-news-meta">
                        <span class="admin-news-date">{{ noticia.fecha.split(' ')[0] }} {{ noticia.fecha.split(' ')[1].split('.')[0] }}</span>
                        {% if noticia.importante %}
                        <span class="admin-news-important">üì¢ Importante</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="admin-news-content">
                      <p>{{ noticia.contenido[:150] }}{% if noticia.contenido|length > 150 %}...{% endif %}</p>
                    </div>
                    <div class="admin-news-actions">
                      <form method="POST" action="/admin/delete_news" class="inline-form" onsubmit="return confirm('¬øEst√°s seguro de eliminar esta noticia?')">
                        <input type="hidden" name="news_id" value="{{ noticia.id }}">
                        <button type="submit" class="btn btn-delete-news">üóëÔ∏è Eliminar</button>
                      </form>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="no-news-admin">
                  <p>üì∞ No hay noticias publicadas. Crea la primera noticia usando el formulario de arriba.</p>
                </div>
              {% endif %}
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Datos embebidos para JavaScript -->
  <script type="application/json" id="freefire-latam-data">
    [
      {% for price in prices %}
      {
        "id": {{ price.id }},
        "nombre": "{{ price.nombre }}",
        "precio": {{ price.precio }}
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  </script>

  <script type="application/json" id="freefire-global-data">
    [
      {% for price in freefire_global_prices %}
      {
        "id": {{ price.id }},
        "nombre": "{{ price.nombre }}",
        "precio": {{ price.precio }}
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  </script>

  <script>
    // Auto-ocultar mensajes flash despu√©s de 2 segundos
    setTimeout(function() {
      const flashMessages = document.querySelector('.flash-messages-main');
      if (flashMessages) {
        flashMessages.style.opacity = '0';
        setTimeout(() => flashMessages.remove(), 300);
      }
    }, 2000);

    // Sistema de pesta√±as
    function showTab(tabName) {
      // Ocultar todas las pesta√±as
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tab => {
        tab.classList.remove('active');
      });

      // Desactivar todos los botones
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => {
        button.classList.remove('active');
      });

      // Mostrar la pesta√±a seleccionada
      document.getElementById('tab-' + tabName).classList.add('active');
      
      // Activar el bot√≥n correspondiente
      event.target.classList.add('active');
    }

    // Actualizar informaci√≥n de precios
    function updatePriceInfo() {
      const select = document.getElementById('package_select');
      const selectedOption = select.options[select.selectedIndex];
      const priceInfo = document.getElementById('price-info');
      
      if (selectedOption.value) {
        const currentPrice = selectedOption.getAttribute('data-current-price');
        const name = selectedOption.getAttribute('data-name');
        const description = selectedOption.getAttribute('data-description');
        
        document.getElementById('selected-package-name').textContent = name;
        document.getElementById('selected-package-description').textContent = description;
        document.getElementById('current-price-value').textContent = '$' + parseFloat(currentPrice).toFixed(2);
        document.getElementById('new_price_input').value = currentPrice;
        
        priceInfo.style.display = 'block';
      } else {
        priceInfo.style.display = 'none';
        document.getElementById('new_price_input').value = '';
      }
    }

    // Datos de paquetes desde elementos HTML
    const freefireLatamPackages = JSON.parse(document.getElementById('freefire-latam-data').textContent);
    const freefireGlobalPackages = JSON.parse(document.getElementById('freefire-global-data').textContent);
    const bloodstrikerPackages = [];

    // Funciones para actualizar paquetes con datos din√°micos
    function updateSinglePinPackages() {
      const gameSelect = document.getElementById('game_type_single');
      const packageSelect = document.getElementById('monto_id');
      
      // Limpiar opciones
      packageSelect.innerHTML = '<option value="">Seleccione paquete</option>';
      
      if (gameSelect.value === 'freefire_latam') {
        packageSelect.disabled = false;
        freefireLatamPackages.forEach(pkg => {
          const option = document.createElement('option');
          option.value = pkg.id;
          option.textContent = pkg.nombre + ' / $' + pkg.precio.toFixed(2);
          packageSelect.appendChild(option);
        });
      } else if (gameSelect.value === 'freefire_global') {
        packageSelect.disabled = false;
        freefireGlobalPackages.forEach(pkg => {
          const option = document.createElement('option');
          option.value = pkg.id;
          option.textContent = pkg.nombre + ' / $' + pkg.precio.toFixed(2);
          packageSelect.appendChild(option);
        });
      } else {
        packageSelect.disabled = true;
      }
    }

    function updateBatchPinPackages() {
      const gameSelect = document.getElementById('game_type_batch');
      const packageSelect = document.getElementById('batch_monto_id');
      
      // Limpiar opciones
      packageSelect.innerHTML = '<option value="">Seleccione paquete</option>';
      
      if (gameSelect.value === 'freefire_latam') {
        packageSelect.disabled = false;
        freefireLatamPackages.forEach(pkg => {
          const option = document.createElement('option');
          option.value = pkg.id;
          option.textContent = pkg.nombre + ' / $' + pkg.precio.toFixed(2);
          packageSelect.appendChild(option);
        });
      } else if (gameSelect.value === 'freefire_global') {
        packageSelect.disabled = false;
        freefireGlobalPackages.forEach(pkg => {
          const option = document.createElement('option');
          option.value = pkg.id;
          option.textContent = pkg.nombre + ' / $' + pkg.precio.toFixed(2);
          packageSelect.appendChild(option);
        });
      } else {
        packageSelect.disabled = true;
      }
    }

    // Funci√≥n para actualizar paquetes en gesti√≥n de precios
    function updatePackages() {
      const gameSelect = document.getElementById('game_select');
      const packageSelect = document.getElementById('package_select');
      const priceForm = packageSelect.closest('form');
      
      // Limpiar opciones
      packageSelect.innerHTML = '<option value="">Seleccione un paquete</option>';
      
      if (gameSelect.value === 'freefire') {
        priceForm.action = '/admin/update_price';
        packageSelect.disabled = false;
        freefireLatamPackages.forEach(pkg => {
          const option = document.createElement('option');
          option.value = pkg.id;
          option.setAttribute('data-current-price', pkg.precio);
          option.setAttribute('data-name', pkg.nombre);
          option.setAttribute('data-description', 'Free Fire LATAM - ' + pkg.nombre);
          option.textContent = pkg.nombre;
          packageSelect.appendChild(option);
        });
      } else if (gameSelect.value === 'freefire_global') {
        priceForm.action = '/admin/update_freefire_global_price';
        packageSelect.disabled = false;
        freefireGlobalPackages.forEach(pkg => {
          const option = document.createElement('option');
          option.value = pkg.id;
          option.setAttribute('data-current-price', pkg.precio);
          option.setAttribute('data-name', pkg.nombre);
          option.setAttribute('data-description', 'Free Fire - ' + pkg.nombre);
          option.textContent = pkg.nombre;
          packageSelect.appendChild(option);
        });
      } else if (gameSelect.value === 'bloodstriker') {
        priceForm.action = '/admin/update_bloodstriker_price';
        packageSelect.disabled = false;
        bloodstrikerPackages.forEach(pkg => {
          const option = document.createElement('option');
          option.value = pkg.id;
          option.setAttribute('data-current-price', pkg.precio);
          option.setAttribute('data-name', pkg.nombre);
          option.setAttribute('data-description', 'Blood Striker - ' + pkg.nombre);
          option.textContent = pkg.nombre;
          packageSelect.appendChild(option);
        });
      } else {
        packageSelect.disabled = true;
        priceForm.action = '/admin/update_price';
      }
      
      // Ocultar informaci√≥n de precio
      document.getElementById('price-info').style.display = 'none';
      document.getElementById('new_price_input').value = '';
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      updatePackages();
    });
  </script>
</body>
</html>

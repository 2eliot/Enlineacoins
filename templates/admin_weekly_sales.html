<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas de Ventas Semanales - Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <style>
        .sales-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .sales-header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .sales-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .sales-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .cleanup-button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .cleanup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .week-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .week-selector select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-top: 4px solid #007bff;
        }
        
        .summary-card.revenue {
            border-top-color: #28a745;
        }
        
        .summary-card.units {
            border-top-color: #17a2b8;
        }
        
        .summary-card.profit {
            border-top-color: #ffc107;
        }
        
        .summary-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        
        .summary-label {
            color: #666;
            font-size: 1em;
            font-weight: 500;
        }
        
        .back-button {
            display: inline-block;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 12px 25px;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-decoration: none;
            color: white;
        }
        
        .game-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .game-header {
            padding: 20px 30px;
            font-size: 1.4em;
            font-weight: 600;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .freefire-latam .game-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .freefire-global .game-header {
            background: linear-gradient(135deg, #4834d4, #686de0);
        }
        
        .bloodstriker .game-header {
            background: linear-gradient(135deg, #130f40, #30336b);
        }
        
        .game-stats {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .sales-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .sales-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .sales-table tr:hover {
            background: #f8f9fa;
        }
        
        .package-name {
            font-weight: 600;
            color: #333;
        }
        
        .price-cell {
            font-weight: 600;
            color: #28a745;
        }
        
        .units-cell {
            font-weight: 600;
            color: #17a2b8;
        }
        
        .profit-cell {
            font-weight: 600;
            color: #ffc107;
        }
        
        .week-cell {
            font-size: 0.9em;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-data h3 {
            margin-bottom: 10px;
            color: #999;
        }
        
        .automation-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .automation-info h3 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
        }
        
        .automation-info p {
            margin: 5px 0;
            opacity: 0.9;
        }
        
        .cleanup-form {
            display: inline-block;
        }
        
        .week-filter {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .week-filter h4 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .filter-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .filter-button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .filter-button.active {
            background: #28a745;
        }
    </style>
</head>
<body>
    <div class="sales-container">
        <a href="{{ url_for('admin') }}" class="back-button">‚Üê Volver al Panel Admin</a>
        
        <div class="sales-header">
            <h1>üìà Estad√≠sticas de Ventas Semanales</h1>
            <p>An√°lisis detallado de unidades vendidas y ganancias acumuladas por semana</p>
        </div>
        
        <div class="automation-info">
            <h3>ü§ñ Automatizaci√≥n de Almacenamiento</h3>
            <p>‚Ä¢ Los datos de ventas se registran autom√°ticamente con cada transacci√≥n</p>
            <p>‚Ä¢ Se recomienda limpiar datos antiguos semanalmente para mantener la base de datos optimizada</p>
            <p>‚Ä¢ Los datos se agrupan por semana ISO (YYYY-WW) para an√°lisis consistente</p>
        </div>
        
        <div class="controls-section">
            <div class="week-selector">
                <label for="week-filter"><strong>Filtrar por semana:</strong></label>
                <select id="week-filter" onchange="filterByWeek()">
                    <option value="">Todas las semanas</option>
                    {% for week in available_weeks %}
                    <option value="{{ week }}">Semana {{ week }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <form method="POST" action="{{ url_for('clean_weekly_sales') }}" class="cleanup-form" 
                  onsubmit="return confirm('¬øEst√°s seguro de que deseas eliminar todos los datos de ventas semanales? Esta acci√≥n no se puede deshacer.')">
                <button type="submit" class="cleanup-button">üóëÔ∏è Limpiar Datos Antiguos</button>
            </form>
        </div>
        
        {% if sales_data %}
        <div class="summary-cards">
            <div class="summary-card units">
                <div class="summary-value">{{ total_units }}</div>
                <div class="summary-label">Unidades Vendidas Total</div>
            </div>
            <div class="summary-card revenue">
                <div class="summary-value">${{ "%.2f"|format(total_revenue) }}</div>
                <div class="summary-label">Ingresos Totales</div>
            </div>
            <div class="summary-card profit">
                <div class="summary-value">${{ "%.2f"|format(total_profit) }}</div>
                <div class="summary-label">Ganancia Total Estimada</div>
            </div>
            <div class="summary-card">
                <div class="summary-value">{{ unique_weeks }}</div>
                <div class="summary-label">Semanas con Ventas</div>
            </div>
        </div>
        
        {% for juego, game_sales in sales_data|groupby('juego') %}
        <div class="game-section {{ juego.replace('_', '-') }}">
            <div class="game-header">
                <span>
                    {% if juego == 'freefire_latam' %}
                        üî• Free Fire LATAM
                    {% elif juego == 'freefire_global' %}
                        üåç Free Fire Global
                    {% elif juego == 'bloodstriker' %}
                        ‚öîÔ∏è Blood Striker
                    {% endif %}
                </span>
                <div class="game-stats">
                    {% set game_units = game_sales|sum(attribute='cantidad_vendida') %}
                    {% set game_revenue = game_sales|sum(attribute='ingresos_totales') %}
                    {{ game_units }} unidades ‚Ä¢ ${{ "%.2f"|format(game_revenue) }} ingresos
                </div>
            </div>
            
            <table class="sales-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Semana</th>
                        <th>Precio Unitario</th>
                        <th>Unidades Vendidas</th>
                        <th>Ingresos Totales</th>
                        <th>Ganancia Estimada</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in game_sales|sort(attribute='semana', reverse=true) %}
                    <tr class="sale-row" data-week="{{ sale.semana }}">
                        <td class="package-name">{{ sale.paquete_nombre }}</td>
                        <td class="week-cell">{{ sale.semana }}</td>
                        <td class="price-cell">${{ "%.2f"|format(sale.precio_venta) }}</td>
                        <td class="units-cell">{{ sale.cantidad_vendida }}</td>
                        <td class="price-cell">${{ "%.2f"|format(sale.ingresos_totales) }}</td>
                        <td class="profit-cell">
                            {% if sale.ganancia_estimada %}
                                ${{ "%.2f"|format(sale.ganancia_estimada) }}
                            {% else %}
                                <span style="color: #999;">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
        
        {% else %}
        <div class="game-section">
            <div class="no-data">
                <h3>üìä Sin Datos de Ventas</h3>
                <p>No hay estad√≠sticas de ventas disponibles a√∫n.</p>
                <p>Los datos se generar√°n autom√°ticamente cuando se realicen transacciones.</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <script>
        function filterByWeek() {
            const selectedWeek = document.getElementById('week-filter').value;
            const rows = document.querySelectorAll('.sale-row');
            
            rows.forEach(row => {
                if (selectedWeek === '' || row.dataset.week === selectedWeek) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update summary cards based on visible rows
            updateSummaryCards();
        }
        
        function updateSummaryCards() {
            const visibleRows = document.querySelectorAll('.sale-row:not([style*="display: none"])');
            let totalUnits = 0;
            let totalRevenue = 0;
            let totalProfit = 0;
            const uniqueWeeks = new Set();
            
            visibleRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const units = parseInt(cells[3].textContent);
                const revenue = parseFloat(cells[4].textContent.replace('$', ''));
                const profitText = cells[5].textContent.replace('$', '');
                const profit = profitText !== 'N/A' ? parseFloat(profitText) : 0;
                const week = cells[1].textContent;
                
                totalUnits += units;
                totalRevenue += revenue;
                totalProfit += profit;
                uniqueWeeks.add(week);
            });
            
            // Update summary cards if they exist
            const summaryCards = document.querySelectorAll('.summary-value');
            if (summaryCards.length >= 4) {
                summaryCards[0].textContent = totalUnits;
                summaryCards[1].textContent = '$' + totalRevenue.toFixed(2);
                summaryCards[2].textContent = '$' + totalProfit.toFixed(2);
                summaryCards[3].textContent = uniqueWeeks.size;
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up any initial filters or sorting
            updateSummaryCards();
        });
    </script>
</body>
</html>
